name: Issue Branch Automation

on:
  issues:
    types: [opened]
  pull_request:
    types: [closed]

jobs:
  create-branch:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract branch prefix from labels
        id: extract-prefix
        run: |
          LABELS=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[].name')
          PREFIX="feat"  # ê¸°ë³¸ê°’

          for label in $LABELS; do
            case "$label" in
              "bug"|"fix") PREFIX="fix" ;;
              "feature"|"enhancement") PREFIX="feat" ;;
              "refactor"|"refactoring") PREFIX="refactor" ;;
              "chore"|"maintenance") PREFIX="chore" ;;
              "docs"|"documentation") PREFIX="docs" ;;
              "hotfix") PREFIX="hotfix" ;;
              "test"|"testing") PREFIX="test" ;;
            esac
          done

          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT

      - name: Sanitize title and create branch name
        id: create-branch-name
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          PREFIX=${{ steps.extract-prefix.outputs.prefix }}
          ISSUE_TITLE="${{ github.event.issue.title }}"

          echo "Debug - Original title: '$ISSUE_TITLE'"
          echo "Debug - Issue number: '$ISSUE_NUMBER'"
          echo "Debug - Prefix: '$PREFIX'"

          # ì œëª©ì´ ë¹„ì–´ìˆê±°ë‚˜ ê³µë°±ë§Œ ìˆëŠ” ê²½ìš° ì²´í¬
          if [[ -z "$ISSUE_TITLE" || "$ISSUE_TITLE" =~ ^[[:space:]]*$ ]]; then
            echo "Warning: Issue title is empty or contains only whitespace"
            SANITIZED_TITLE="issue"
          else
            # ì œëª© ì •ë¦¬ ë‹¨ê³„ë³„ ì²˜ë¦¬
            # 1. ë¨¼ì € **ë¥¼ ì œê±°í•˜ê³  ê³µë°± ì •ë¦¬
            TEMP_TITLE=$(echo "$ISSUE_TITLE" | sed 's/\*\*//g' | sed 's/^ *//g' | sed 's/ *$//g')
            echo "Debug - After removing **: '$TEMP_TITLE'"
            
            # 2. ì†Œë¬¸ì ë³€í™˜
            TEMP_TITLE=$(echo "$TEMP_TITLE" | tr '[:upper:]' '[:lower:]')
            echo "Debug - After lowercase: '$TEMP_TITLE'"
            
            # 3. í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ìë¥¼ í•˜ì´í”ˆìœ¼ë¡œ ë³€ê²½ (ì˜ë¬¸, ìˆ«ì, í•œê¸€, í•˜ì´í”ˆ, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ í—ˆìš©)
            TEMP_TITLE=$(echo "$TEMP_TITLE" | sed 's/[^a-z0-9ê°€-í£ã„±-ã…ã…-ã…£_-]/-/g')
            echo "Debug - After char replacement: '$TEMP_TITLE'"
            
            # 4. ì—°ì†ëœ í•˜ì´í”ˆì„ í•˜ë‚˜ë¡œ ì¤„ì´ê¸°
            TEMP_TITLE=$(echo "$TEMP_TITLE" | sed 's/-\+/-/g')
            echo "Debug - After dash reduction: '$TEMP_TITLE'"
            
            # 5. ì•ë’¤ í•˜ì´í”ˆ ì œê±°
            TEMP_TITLE=$(echo "$TEMP_TITLE" | sed 's/^-\+//' | sed 's/-\+$//')
            echo "Debug - After trim dashes: '$TEMP_TITLE'"
            
            # 6. ê¸¸ì´ ì œí•œ (50ì)
            if [[ ${#TEMP_TITLE} -gt 50 ]]; then
              TEMP_TITLE="${TEMP_TITLE:0:50}"
              # ëì— í•˜ì´í”ˆì´ ìˆìœ¼ë©´ ì œê±°
              TEMP_TITLE=$(echo "$TEMP_TITLE" | sed 's/-\+$//')
            fi
            
            # 7. ì—¬ì „íˆ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
            if [[ -z "$TEMP_TITLE" || "$TEMP_TITLE" == "-" ]]; then
              SANITIZED_TITLE="issue"
            else
              SANITIZED_TITLE="$TEMP_TITLE"
            fi
          fi

          BRANCH_NAME="${PREFIX}/${ISSUE_NUMBER}-${SANITIZED_TITLE}"

          echo "Debug - Sanitized title: '$SANITIZED_TITLE'"
          echo "Debug - Final branch name: '$BRANCH_NAME'"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "sanitized_title=$SANITIZED_TITLE" >> $GITHUB_OUTPUT

      - name: Debug branch values
        run: |
          echo "=== Debug Information ==="
          echo "Original title: '${{ github.event.issue.title }}'"
          echo "Sanitized title: '${{ steps.create-branch-name.outputs.sanitized_title }}'"
          echo "Branch name: '${{ steps.create-branch-name.outputs.branch_name }}'"
          echo "Issue number: '${{ github.event.issue.number }}'"
          echo "Prefix: '${{ steps.extract-prefix.outputs.prefix }}'"
          echo "========================"

      - name: Create and push branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
          
          echo "=== Branch Creation Process ==="
          echo "Branch name: '${{ steps.create-branch-name.outputs.branch_name }}'"
          
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ë¸Œëœì¹˜ëª… ìœ íš¨ì„± ê²€ì‚¬
          BRANCH_NAME="${{ steps.create-branch-name.outputs.branch_name }}"
          if [[ -z "$BRANCH_NAME" ]]; then
            echo "ERROR: Branch name is empty!"
            exit 1
          fi
          
          echo "Fetching origin..."
          git fetch origin
          
          # ë² ì´ìŠ¤ ë¸Œëœì¹˜ í™•ì¸
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            BASE_BRANCH="develop"
          elif git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_BRANCH="main"
          else
            echo "ERROR: Neither develop nor main branch found!"
            git branch -r
            exit 1
          fi
          
          echo "Base branch: $BASE_BRANCH"
          
          # ë¸Œëœì¹˜ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git show-ref --verify --quiet refs/remotes/origin/"$BRANCH_NAME"; then
            echo "WARNING: Branch $BRANCH_NAME already exists!"
            exit 0
          fi
          
          # ë¸Œëœì¹˜ ìƒì„±
          echo "Creating branch: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME" origin/$BASE_BRANCH
          
          if [[ $? -ne 0 ]]; then
            echo "ERROR: Failed to create branch!"
            exit 1
          fi
          
          # ë¸Œëœì¹˜ í‘¸ì‹œ
          echo "Pushing branch: $BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          if [[ $? -ne 0 ]]; then
            echo "ERROR: Failed to push branch!"
            exit 1
          fi
          
          echo "SUCCESS: Branch created and pushed successfully!"

      - name: Add branch info to issue
        if: success()
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸš€ **ë¸Œëœì¹˜ê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**

            **ë¸Œëœì¹˜ëª…**: `${{ steps.create-branch-name.outputs.branch_name }}`

            ### ë‹¤ìŒ ë‹¨ê³„
            1. ë¡œì»¬ì—ì„œ ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ:
               ```bash
               git fetch origin
               git checkout ${{ steps.create-branch-name.outputs.branch_name }}
               ```
            2. ì‘ì—… ì™„ë£Œ í›„ PR ìƒì„±
            3. PRì´ ë¨¸ì§€ë˜ë©´ ë¸Œëœì¹˜ì™€ ì´ìŠˆê°€ ìë™ìœ¼ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤

            > ğŸ’¡ **íŒ**: PR ì œëª©ì— `closes #${{ github.event.issue.number }}` ë˜ëŠ” `fixes #${{ github.event.issue.number }}`ë¥¼ í¬í•¨í•˜ë©´ ì´ìŠˆê°€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.

      - name: Add error info to issue
        if: failure()
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            âŒ **ë¸Œëœì¹˜ ìƒì„± ì‹¤íŒ¨!**

            **ì˜¤ë¥˜**: ë¸Œëœì¹˜ ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            **ì˜ˆìƒ ë¸Œëœì¹˜ëª…**: `${{ steps.create-branch-name.outputs.branch_name }}`

            ### í™•ì¸ì‚¬í•­
            - ë¸Œëœì¹˜ëª…ì— íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            - ë™ì¼í•œ ë¸Œëœì¹˜ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            - GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ìì„¸í•œ ì˜¤ë¥˜ ë‚´ìš© í™•ì¸

            ìˆ˜ë™ìœ¼ë¡œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ì´ìŠˆ ì œëª©ì„ ìˆ˜ì • í›„ ìƒˆ ì´ìŠˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

      - name: Add labels to issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ---
            ğŸ·ï¸ **ë¸Œëœì¹˜ ì •ë³´**
            - **íƒ€ì…**: `${{ steps.extract-prefix.outputs.prefix }}`
            - **ë¸Œëœì¹˜**: `${{ steps.create-branch-name.outputs.branch_name }}`
            - **ìƒíƒœ**: ğŸ”„ ì§„í–‰ ì¤‘

  cleanup-after-merge:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue number from branch name
        id: extract-issue
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '/[0-9]+' | sed 's/\///')

          if [[ "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "has_issue=true" >> $GITHUB_OUTPUT
          else
            echo "has_issue=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete merged branch
        if: steps.extract-issue.outputs.has_issue == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ steps.extract-issue.outputs.branch_name }}"
          git push origin --delete "$BRANCH_NAME" || echo "ë¸Œëœì¹˜ ì‚­ì œ ì‹¤íŒ¨ ë˜ëŠ” ì´ë¯¸ ì‚­ì œë¨"

      - name: Close related issue
        if: steps.extract-issue.outputs.has_issue == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.extract-issue.outputs.issue_number }}
          body: |
            âœ… **ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**

            **PR**: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            **ë¸Œëœì¹˜**: `${{ steps.extract-issue.outputs.branch_name }}` (ì‚­ì œë¨)
            **ë¨¸ì§€ ì‹œê°„**: ${{ github.event.pull_request.merged_at }}

            ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤. ğŸ‰

      - name: Close issue
        if: steps.extract-issue.outputs.has_issue == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ steps.extract-issue.outputs.issue_number }}
          gh issue close $ISSUE_NUMBER --reason completed
