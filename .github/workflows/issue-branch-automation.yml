name: Auto Create Branch from Issue

on:
  issues:
    types: [opened, labeled]

jobs:
  create-branch:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'create-branch') || contains(github.event.issue.title, '[FEATURE]') || contains(github.event.issue.title, '[BUG]') || contains(github.event.issue.title, '[HOTFIX]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract branch name from issue title
        id: extract_branch
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # ëŒ€ê´„í˜¸ ì•ˆì˜ íƒœê·¸ ì œê±° ([FEATURE], [BUG], [HOTFIX] ë“±)
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/\[[^]]*\]//g' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
          
          # ì´ìŠˆ ë²ˆí˜¸ ì¶”ê°€
          FINAL_BRANCH_NAME="issue-${ISSUE_NUMBER}-${BRANCH_NAME}"
          
          echo "branch_name=$FINAL_BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "clean_title=$CLEAN_TITLE" >> $GITHUB_OUTPUT
          
          echo "ì›ë³¸ ì œëª©: $ISSUE_TITLE"
          echo "ì •ë¦¬ëœ ì œëª©: $CLEAN_TITLE"
          echo "ìƒì„±ë  ë¸Œëœì¹˜ëª…: $FINAL_BRANCH_NAME"

      - name: Create branch
        run: |
          BRANCH_NAME="${{ steps.extract_branch.outputs.branch_name }}"
          
          # ë¸Œëœì¹˜ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "ë¸Œëœì¹˜ '$BRANCH_NAME'ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          # ìƒˆ ë¸Œëœì¹˜ ìƒì„± ë° í‘¸ì‹œ
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          echo "âœ… ë¸Œëœì¹˜ '$BRANCH_NAME'ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.extract_branch.outputs.branch_name }}';
            const cleanTitle = '${{ steps.extract_branch.outputs.clean_title }}';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ **ë¸Œëœì¹˜ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**
              
**ë¸Œëœì¹˜ëª…:** \`${branchName}\`
**ì •ë¦¬ëœ ì œëª©:** ${cleanTitle}

ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë¸Œëœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
\`\`\`bash
git fetch origin
git checkout ${branchName}
\`\`\`

ë˜ëŠ” GitHubì—ì„œ ì§ì ‘ ì‘ì—…í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
            });

      - name: Add assignee and labels
        uses: actions/github-script@v7
        with:
          script: |
            // ì´ìŠˆ ì‘ì„±ìë¥¼ assigneeë¡œ ì¶”ê°€
            github.rest.issues.addAssignees({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              assignees: [context.payload.issue.user.login]
            });
            
            // 'in-progress' ë¼ë²¨ ì¶”ê°€
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['in-progress']
            });
